{
  "Outputs": {
    "AWSEBWorkerQueueURL": {
      "Value": {
        "Ref": "AWSEBWorkerQueue"
      },
      "Description": "URL of the worker queue"
    },
    "AWSEBWorkerDeadLetterQueueURL": {
      "Value": {
        "Ref": "AWSEBWorkerDeadLetterQueue"
      },
      "Description": "URL of the worker dead letter queue"
    }
  },
  "Parameters": {
    "DockerRPM": {
      "Default": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/docker-1.0.0-1.15.amzn1.x86_64.rpm",
      "NoEcho": "false",
      "Description": "Docker rpm",
      "Type": "String"
    },
    "LogPublicationControl": {
      "Default": "false",
      "NoEcho": "false",
      "Description": "If true customer service logs will be published to S3.",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Type": "String",
      "ConstraintDescription": "must be Boolean."
    },
    "AWSEBVisibilityTimeout": {
      "Default": 300,
      "NoEcho": "false",
      "Description": "The amount of time in seconds an incoming message is locked for processing",
      "Type": "Number"
    },
    "AWSEBAgentId": {
      "Default": "",
      "NoEcho": "false",
      "Type": "String"
    },
    "AWSEBWorkerQueueURL": {
      "Default": "",
      "NoEcho": "false",
      "Description": "The URL to the worker SQS queue",
      "Type": "String"
    },
    "AWSEBEnvironmentName": {
      "NoEcho": "false",
      "Type": "String"
    },
    "AWSEBHttpPath": {
      "Default": "\/",
      "NoEcho": "false",
      "Description": "The relative path to the app to which we post",
      "Type": "String"
    },
    "InstanceType": {
      "Default": "t1.micro",
      "NoEcho": "false",
      "Description": "WebServer EC2 instance type",
      "AllowedValues": [
        "t1.micro",
        "m1.small",
        "m3.medium",
        "m3.large",
        "m3.xlarge"
      ],
      "Type": "String",
      "ConstraintDescription": "must be a valid General Purpose EC2 instance type."
    },
    "AWSEBMaxRetries": {
      "Default": 10,
      "NoEcho": "false",
      "Description": "The maximum number of retries after which the message is discarded",
      "Type": "Number"
    },
    "AWSEBHealthCheck": {
      "Default": "",
      "NoEcho": "false",
      "Description": "The serialized value of the application healthcheck",
      "Type": "String"
    },
    "AWSEBReferrerId": {
      "Default": "",
      "NoEcho": "false",
      "Type": "String"
    },
    "DockerDEB": {
      "Default": "",
      "NoEcho": "false",
      "Description": "Docker deb",
      "Type": "String"
    },
    "DockerProxyServer": {
      "Default": "nginx",
      "NoEcho": "false",
      "AllowedValues": [
        "nginx",
        "none"
      ],
      "Description": "Specifies which proxy server to be used for client connections.",
      "Type": "String"
    },
    "AWSEBHttpConnections": {
      "Default": 50,
      "NoEcho": "false",
      "Description": "The maximum number of concurrent connections to the applications",
      "Type": "Number"
    },
    "InstancePort": {
      "Default": "80",
      "NoEcho": "false",
      "Description": "Listen Port",
      "Type": "String"
    },
    "AWSEBEnvironmentId": {
      "NoEcho": "false",
      "Type": "String"
    },
    "AWSEBMimeType": {
      "Default": "application\/json",
      "NoEcho": "false",
      "Description": "The mime type of the message being sent",
      "Type": "String"
    },
    "AWSEBEnvironmentBucket": {
      "NoEcho": "false",
      "Type": "String"
    },
    "AppSource": {
      "Default": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-samples-us-east-1\/docker-sample-v2.zip",
      "NoEcho": "false",
      "Description": "Application Source",
      "Type": "String"
    },
    "AWSEBInactivityTimeout": {
      "Default": 180,
      "NoEcho": "false",
      "Description": "The timeout in seconds for existing connections to the application",
      "Type": "Number"
    },
    "AWSEBConnectTimeout": {
      "Default": 5,
      "NoEcho": "false",
      "Description": "The timeout in seconds for new connections to the application",
      "Type": "Number"
    },
    "AWSEBWorkerDeadLetterQueueURL": {
      "Default": "",
      "NoEcho": "false",
      "Description": "The URL to the worker dead letter SQS queue",
      "Type": "String"
    },
    "AWSEBRetentionPeriod": {
      "Default": 345600,
      "NoEcho": "false",
      "Description": "The amount of time in seconds a message is valid and will be actively processed",
      "Type": "Number"
    },
    "EnvironmentVariables": {
      "Default": "AWS_ACCESS_KEY_ID=,AWS_SECRET_KEY=,PARAM1=,PARAM2=,PARAM3=,PARAM4=,PARAM5=",
      "NoEcho": "false",
      "Description": "Program environment variables.",
      "Type": "CommaDelimitedList"
    }
  },
  "Description": "AWS Elastic Beanstalk environment (Name: 'dockertest-env'  Id: 'e-fucvpi5vsv')",
  "Mappings": {
    "EnvironmentInfoTasks": {
      "systemtail": {
        "AutoClean": "true",
        "CommandName": "CMD-SystemTailLogs",
        "LocationPrefix": "resources\/environments\/logs\/systemtail\/"
      },
      "bundle": {
        "CommandName": "CMD-BundleLogs",
        "LocationPrefix": "resources\/environments\/logs\/bundle\/"
      },
      "publish": {
        "LocationPrefix": "resources\/environments\/logs\/publish\/"
      },
      "tail": {
        "AutoClean": "true",
        "CommandName": "CMD-TailLogs",
        "LocationPrefix": "resources\/environments\/logs\/tail\/"
      }
    },
    "AWSEBOptions": {
      "options": {
        "FastVersionDeployment": "true",
        "nodeploymentOnStartup": "true",
        "EnvironmentType": "SingleInstance",
        "CloudConfigOptions": "",
        "HaltStartupCommandsOnFailure": "true",
        "ebrpm": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/aws-elasticbeanstalk-tools-1.12-1.noarch.rpm",
        "EnvironmentTier": [
          {
            "Name": "Worker",
            "Type": "SQS\/HTTP",
            "Version": "1.1"
          }
        ],
        "cfnrpm": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/python-certifi-0.0.8-2.3.amzn1.noarch.rpm https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/aws-cfn-bootstrap-1.4-b165.noarch.rpm",
        "DefaultSSHPort": "22",
        "UserDataScript": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/UserDataScript.sh",
        "requests": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/requests-0.13.5.tar.gz#md5=805fd122b4cfd224e15ff2f5288c5ba0",
        "DefaultsScript": "\/opt\/elasticbeanstalk\/containerfiles\/support\/container_defaults.py",
        "LeaderTestScript": "\/opt\/elasticbeanstalk\/bin\/leader-test.sh",
        "LaunchType": "Migration",
        "downloadSourceBundleScriptLocation": [
          "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/eb_patching_resources\/download_source_bundle.py"
        ],
        "EmbeddedConfigsetsEnabled": "true"
      }
    },
    "AWSEBAWSRegionArch2AMI": {
      "us-east-1": {
        "64hvm": "ami-8cd529e4",
        "64": "ami-b2d529da",
        "64graphics": "ami-ad5f47c4",
        "64gpu": "ami-56d62a3e"
      },
      "us-west-1": {
        "64hvm": "ami-b69493f3",
        "64": "ami-aa9493ef",
        "64graphics": "ami-f63800b3",
        "64gpu": ""
      },
      "us-west-2": {
        "64hvm": "ami-e75c21d7",
        "64": "ami-e35c21d3",
        "64graphics": "ami-1ad3b92a",
        "64gpu": ""
      }
    },
    "AWSEBAWSInstanceType2Arch": {
      "t1.micro": {
        "Arch": "64"
      },
      "m1.small": {
        "Arch": "64"
      },
      "m3.medium": {
        "Arch": "64"
      },
      "m3.large": {
        "Arch": "64"
      },
      "m3.xlarge": {
        "Arch": "64"
      }
    }
  },
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "AWSEBAutoScalingLaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "IamInstanceProfile": "LaunchConfig_WebApp",
        "ImageId": {
          "Fn::FindInMap": [
            "AWSEBAWSRegionArch2AMI",
            {
              "Ref": "AWS::Region"
            },
            {
              "Fn::FindInMap": [
                "AWSEBAWSInstanceType2Arch",
                {
                  "Ref": "InstanceType"
                },
                "Arch"
              ]
            }
          ]
        },
        "InstanceMonitoring": false,
        "SecurityGroups": [
          {
            "Ref": "AWSEBSecurityGroup"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "Content-Type: multipart\/mixed; boundary=\"===============5189065377222898407==\"",
                "\n",
                "MIME-Version: 1.0",
                "\n",
                "",
                "\n",
                "--===============5189065377222898407==",
                "\n",
                "Content-Type: text\/cloud-config; charset=\"us-ascii\"",
                "\n",
                "MIME-Version: 1.0",
                "\n",
                "Content-Transfer-Encoding: 7bit",
                "\n",
                "Content-Disposition: attachment; filename=\"cloud-config.txt\"",
                "\n",
                "",
                "\n",
                "#cloud-config",
                "\n",
                "repo_upgrade: none",
                "\n",
                "repo_releasever: 2014.03",
                "\n",
                {
                  "Fn::FindInMap": [
                    "AWSEBOptions",
                    "options",
                    "CloudConfigOptions"
                  ]
                },
                "\n",
                "",
                "\n",
                "--===============5189065377222898407==",
                "\n",
                "Content-Type: text\/x-shellscript; charset=\"us-ascii\"",
                "\n",
                "MIME-Version: 1.0",
                "\n",
                "Content-Transfer-Encoding: 7bit",
                "\n",
                "Content-Disposition: attachment; filename=\"user-data.txt\"",
                "\n\n",
                "#!\/bin\/bash",
                "\n",
                "exec > >(tee -a \/var\/log\/eb-cfn-init.log|logger -t [eb-cfn-init] -s 2>\/dev\/console) 2>&1",
                "\n",
                "set -x",
                "\n",
                "\n\n",
                "function sleep_delay ",
                "\n",
                "{",
                "\n",
                "  if (( $SLEEP_TIME < $SLEEP_TIME_MAX )); then ",
                "\n",
                "    echo Sleeping $SLEEP_TIME",
                "\n",
                "    sleep $SLEEP_TIME  ",
                "\n",
                "    SLEEP_TIME=$(($SLEEP_TIME * 2)) ",
                "\n",
                "  else ",
                "\n",
                "    echo Sleeping $SLEEP_TIME_MAX  ",
                "\n",
                "    sleep $SLEEP_TIME_MAX  ",
                "\n",
                "  fi",
                "\n",
                "}",
                "\n\n",
                "# Executing bootstrap script",
                "\n",
                "SLEEP_TIME=10",
                "\n",
                "SLEEP_TIME_MAX=3600",
                "\n",
                "while true; do ",
                "\n",
                "  curl ",
                {
                  "Fn::FindInMap": [
                    "AWSEBOptions",
                    "options",
                    "UserDataScript"
                  ]
                },
                " > \/tmp\/ebbootstrap.sh ",
                "\n",
                "  RESULT=$?",
                "\n",
                "  if [[ \"$RESULT\" -ne 0 ]]; then ",
                "\n",
                "    sleep_delay ",
                "\n",
                "  else",
                "\n",
                "    \/bin\/bash \/tmp\/ebbootstrap.sh ",
                "    '",
                {
                  "Fn::FindInMap": [
                    "AWSEBOptions",
                    "options",
                    "requests"
                  ]
                },
                "'",
                "    '",
                {
                  "Fn::FindInMap": [
                    "AWSEBOptions",
                    "options",
                    "cfnrpm"
                  ]
                },
                "'",
                "    '",
                {
                  "Ref": "AWSEBInstanceLaunchWaitHandle"
                },
                "'",
                "    '",
                {
                  "Ref": "AWS::StackId"
                },
                "'",
                "    '",
                {
                  "Ref": "AWS::Region"
                },
                "'",
                "    & ",
                "\n",
                "    exit 0  ",
                "\n",
                "  fi ",
                "\n",
                "done",
                "\n\n",
                "--===============5189065377222898407==-- "
              ]
            ]
          }
        },
        "KeyName": "paul-ami-pair",
        "InstanceType": {
          "Ref": "InstanceType"
        }
      }
    },
    "AWSEBInstanceLaunchWaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "DependsOn": "AWSEBAutoScalingGroup",
      "Properties": {
        "Handle": {
          "Ref": "AWSEBInstanceLaunchWaitHandle"
        },
        "Timeout": "1200",
        "Count": 1
      }
    },
    "AWSEBWorkerDeadLetterQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "MessageRetentionPeriod": 1209600
      }
    },
    "AWSEBAutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Metadata": {
        "AWS::ElasticBeanstalk::Ext": {
          "_EnvironmentInfoTaskMapping": "EnvironmentInfoTasks",
          "_TriggersConfig": {
            "applicationDeploy": {
              "_Command": "CMD-AppDeploy",
              "_WatchGroups": [
                "_TriggerAppDeployment"
              ]
            },
            "configDeploy": {
              "_Command": "CMD-ConfigDeploy",
              "_WatchGroups": [
                "_TriggerConfigDeployment"
              ]
            },
            "sqsdDeploy": {
              "_Command": "CMD-SqsdDeploy",
              "_WatchGroups": [
                "_TriggerSqsdDeployment"
              ]
            }
          },
          "_ParameterTriggers": {
            "_TriggerAppDeployment": [
              "AppSource"
            ],
            "_TriggerSqsdDeployment": [
              "AWSEBWorkerQueueURL",
              "AWSEBWorkerDeadLetterQueueURL",
              "AWSEBHttpPath",
              "AWSEBMimeType",
              "AWSEBMaxRetries",
              "AWSEBHttpConnections",
              "AWSEBConnectTimeout",
              "AWSEBInactivityTimeout",
              "AWSEBVisibilityTimeout",
              "AWSEBRetentionPeriod",
              "AWSEBHealthCheck"
            ],
            "_TriggerConfigDeployment": [
              "LogPublicationControl",
              "InstancePort",
              "EnvironmentVariables",
              "DockerProxyServer"
            ]
          },
          "_SqsDaemonConfigFileContent": {
            "visibility_timeout": {
              "Ref": "AWSEBVisibilityTimeout"
            },
            "sqs_verify_checksums": true,
            "environment_name": {
              "Ref": "AWSEBEnvironmentName"
            },
            "quiet": false,
            "debug": false,
            "connect_timeout": {
              "Ref": "AWSEBConnectTimeout"
            },
            "inactivity_timeout": {
              "Ref": "AWSEBInactivityTimeout"
            },
            "sqs_ssl": true,
            "queue_url": {
              "Ref": "AWSEBWorkerQueue"
            },
            "dynamodb_ssl": true,
            "healthcheck": {
              "Fn::Join": [
                "",
                [
                  "TCP",
                  ":",
                  {
                    "Ref": "InstancePort"
                  }
                ]
              ]
            },
            "concurrent_sqs_polls": 8,
            "retention_period": {
              "Ref": "AWSEBRetentionPeriod"
            },
            "mime_type": {
              "Ref": "AWSEBMimeType"
            },
            "threads": 50,
            "verbose": false,
            "http_connections": {
              "Ref": "AWSEBHttpConnections"
            },
            "sqs_batch_delete": true,
            "http_port": {
              "Ref": "InstancePort"
            },
            "http_path": {
              "Ref": "AWSEBHttpPath"
            },
            "keepalive": true,
            "via_sns": false
          },
          "_ContainerConfigFileContent": {
            "docker": {
              "deb": {
                "Ref": "DockerDEB"
              },
              "rpm": {
                "Ref": "DockerRPM"
              },
              "env": {
                "Ref": "EnvironmentVariables"
              },
              "proxyserver": {
                "Ref": "DockerProxyServer"
              },
              "instanceport": {
                "Ref": "InstancePort"
              }
            },
            "system": {
              "LogPublicationControl": {
                "Ref": "LogPublicationControl"
              },
              "AWSEBReferrerId": {
                "Ref": "AWSEBReferrerId"
              },
              "AWSEBAgentId": {
                "Ref": "AWSEBAgentId"
              }
            }
          },
          "_LaunchS3URL": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-us-east-1-596229110736\/resources\/environments\/e-fucvpi5vsv\/dockertest-env_LaunchFile",
          "_API": {
            "_Commands": {
              "CMD-BundleLogs": {
                "_Stages": {
                  "01_enact": [
                    "InfoTask-BundleLogs"
                  ]
                }
              },
              "CMD-ConfigDeploy": {
                "_Stages": {
                  "02_enact": [
                    "_Infra-SQSD-Stop",
                    "Hook-EnactConfigDeploy",
                    "Hook-PostConfigDeploy",
                    "_Infra-SQSD-Start"
                  ],
                  "01_pre": [
                    "Infra-WriteRuntimeConfig",
                    "Hook-PreConfigDeploy"
                  ]
                },
                "_RunStaged": "true"
              },
              "CMD-SystemTailLogs": {
                "_Stages": {
                  "01_enact": [
                    "InfoTask-SystemTailLogs"
                  ]
                }
              },
              "CMD-TailLogs": {
                "_Stages": {
                  "01_enact": [
                    "InfoTask-TailLogs"
                  ]
                }
              },
              "CMD-Startup": {
                "_Stages": {
                  "02_enact": [
                    "Hook-EnactAppDeploy",
                    "Hook-PostAppDeploy",
                    "Hook-PostInit",
                    "Infra-WriteVersionOnStartup",
                    "_Infra-SQSD-WriteConfig",
                    "_Infra-SQSD-Start"
                  ],
                  "01_pre": [
                    "Infra-EmbeddedPreBuild",
                    "Hook-PreAppDeploy",
                    "Infra-EmbeddedPostBuild"
                  ]
                },
                "_RunStaged": "true"
              },
              "CMD-RestartAppServer": {
                "_Stages": {
                  "02_enact": [
                    "_Infra-SQSD-Stop",
                    "Hook-EnactRestartAppServer",
                    "Hook-PostRestartAppServer",
                    "_Infra-SQSD-Start"
                  ],
                  "01_enact": [
                    "Infra-WriteRuntimeConfig",
                    "Hook-PreRestartAppServer"
                  ]
                },
                "_RunStaged": "false"
              },
              "CMD-SqsdDeploy": {
                "_Stages": {
                  "02_enact": [
                    "_Infra-SQSD-WriteConfig",
                    "_Infra-SQSD-Restart"
                  ]
                },
                "_RunStaged": "true"
              },
              "CMD-AppDeploy": {
                "_Stages": {
                  "02_enact": [
                    "_Infra-SQSD-Stop",
                    "Hook-EnactAppDeploy",
                    "Hook-PostAppDeploy",
                    "_Infra-SQSD-Start"
                  ],
                  "01_pre": [
                    "Infra-WriteRuntimeConfig",
                    "Infra-WriteApplication1",
                    "Infra-WriteApplication2",
                    "Infra-EmbeddedPreBuild",
                    "Hook-PreAppDeploy",
                    "Infra-EmbeddedPostBuild"
                  ]
                },
                "_RunStaged": "true"
              }
            }
          },
          "AvailabilityZoneCount": "Any",
          "_AppSourceUrlFileContent": {
            "url": {
              "Ref": "AppSource"
            }
          }
        },
        "AWS::CloudFormation::Init": {
          "Infra-WriteApplication1": {
            "commands": {
              "01mkdir": {
                "command": "rm -rf \/opt\/elasticbeanstalk\/deploy\/appsource\/; mkdir -p \/opt\/elasticbeanstalk\/deploy\/appsource\/"
              }
            }
          },
          "Infra-WriteBundleLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/eb-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-cfn-hup-call*",
                      "\/var\/log\/eb-cfn-init-call*",
                      "\/var\/log\/eb-cfn-init*",
                      "\/var\/log\/eb-tools*",
                      "\/var\/log\/eb-publish-logs*",
                      "\/var\/log\/directory-hooks-executor*",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/cfn-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cfn-hup*",
                      "\/var\/log\/cfn-init*",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/eb-version-deployment.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-version-deployment.log",
                      ""
                    ]
                  ]
                }
              },
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/cloud-init-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cloud-init*",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cron",
                      "\/var\/log\/messages",
                      "\/var\/log\/yum.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "AWSEBTools": {
            "packages": {
              "python": {
                "requests": "0.13.5",
                "tailer": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/tailer-0.3.tar.gz#md5=9d1fc073e48ca682786d50c077e823ce"
              },
              "rpm": {
                "aws-elasticbeanstalk-tools": {
                  "Fn::FindInMap": [
                    "AWSEBOptions",
                    "options",
                    "ebrpm"
                  ]
                }
              }
            }
          },
          "DockerContainerTailLogs": {
            "commands": {
              "00dockerps": {
                "command": "echo \"'docker ps' ran at `date`: \" >> \/var\/log\/docker-ps.log && docker ps >> \/var\/log\/docker-ps.log"
              }
            }
          },
          "Hook-PostConfigDeploy": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/configdeploy\/post\/"
              }
            }
          },
          "Infra-WriteApplication2": {
            "files": {
              "\/opt\/elasticbeanstalk\/bin\/download_source_bundle": {
                "source": {
                  "Fn::Select": [
                    0,
                    {
                      "Fn::FindInMap": [
                        "AWSEBOptions",
                        "options",
                        "downloadSourceBundleScriptLocation"
                      ]
                    }
                  ]
                },
                "owner": "root",
                "group": "root",
                "mode": "000750"
              }
            },
            "commands": {
              "01downloadVersion": {
                "command": "\/opt\/elasticbeanstalk\/bin\/download_source_bundle"
              },
              "02deleteVersionDownloadScriptFile": {
                "command": "rm \/opt\/elasticbeanstalk\/bin\/download_source_bundle"
              }
            }
          },
          "Infra-SQSD-Restart": {
            "commands": {
              "01-restart-sqsd": {
                "command": "\/etc\/init.d\/aws-sqsd restart"
              }
            }
          },
          "Hook-EnactAppDeploy": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/appdeploy\/enact\/"
              }
            }
          },
          "DockerContainerInstallBundleLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/docker.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-docker\/containers\/eb-current-app\/*",
                      "\/var\/log\/docker-events.log*",
                      "\/var\/log\/docker-ps.log*",
                      "\/var\/log\/nginx\/*",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "Infra-WriteVersionOnStartup": {
            "commands": {
              "01writeversion": {
                "command": "getMetadata.py --resource AWSEBBeanstalkMetadata --path AWS::ElasticBeanstalk::Metadata.Version > \/etc\/elasticbeanstalk\/.aws-eb-startup-version"
              }
            }
          },
          "Hook-PreAppDeploy": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/appdeploy\/pre\/"
              }
            }
          },
          "configSets": {
            "Infra-WriteApplication1": [
              "Infra-WriteApplication1"
            ],
            "_OnInstanceBoot": [
              "DockerContainerInstallHooksPkg",
              "DockerContainerInstallTailLogsConf",
              "DockerContainerInstallSystemTailLogsConf",
              "DockerContainerInstallBundleLogsConf",
              "DockerContainerInstallPublishLogsConf",
              "LockRepoToGuid",
              "AWSEBTools",
              "AWSEBBaseConfig",
              "AWSEBCfnHup",
              "Infra-WriteLeaderTestScript",
              "Infra-WriteRuntimeConfig",
              "Infra-WriteApplication1",
              "Infra-WriteApplication2",
              "Infra-WriteTailLogsConf",
              "Infra-WriteSystemTailLogsConf",
              "Infra-WriteBundleLogsConf",
              "Infra-WritePublishLogsConf",
              "Infra-WritePublishLogsCron",
              {
                "ConfigSet": "_Infra-SQSD-Install"
              }
            ],
            "Infra-WriteBundleLogsConf": [
              "Infra-WriteBundleLogsConf"
            ],
            "Infra-EmbeddedPostBuild": [
              
            ],
            "Hook-PostConfigDeploy": [
              "Hook-PostConfigDeploy"
            ],
            "Infra-WriteApplication2": [
              "Infra-WriteApplication2"
            ],
            "_Infra-SQSD-Install": [
              "Infra-SQSD-Install"
            ],
            "_AppInstall": [
              "Hook-PreInit",
              "Hook-PreAppDeploy",
              "Hook-EnactAppDeploy",
              "Hook-PostAppDeploy",
              "Hook-PostInit",
              {
                "ConfigSet": "_Infra-SQSD-WriteConfig"
              },
              {
                "ConfigSet": "_Infra-SQSD-Start"
              }
            ],
            "Hook-EnactAppDeploy": [
              "Hook-EnactAppDeploy"
            ],
            "Infra-EmbeddedPreBuild": [
              
            ],
            "Infra-WriteVersionOnStartup": [
              "Infra-WriteVersionOnStartup"
            ],
            "Hook-PreAppDeploy": [
              "Hook-PreAppDeploy"
            ],
            "Hook-PreRestartAppServer": [
              "Hook-PreRestartAppServer"
            ],
            "Hook-EnactRestartAppServer": [
              "Hook-EnactRestartAppServer"
            ],
            "Infra-WriteSystemTailLogsConf": [
              "Infra-WriteSystemTailLogsConf"
            ],
            "Infra-WriteRuntimeConfig": [
              "Infra-WriteRuntimeConfig"
            ],
            "Hook-PostRestartAppServer": [
              "Hook-PostRestartAppServer"
            ],
            "Hook-PreInit": [
              "Hook-PreInit"
            ],
            "Infra-WritePublishLogsCron": [
              "Infra-WritePublishLogsCron"
            ],
            "_Infra-SQSD-Restart": [
              "Infra-SQSD-Restart"
            ],
            "InfoTask-TailLogs": [
              "DockerContainerTailLogs",
              "InfoTask-TailLogs"
            ],
            "_OnInstanceReboot": [
              "AWSEBTools",
              "AWSEBBaseConfig",
              "AWSEBCfnHup",
              "Infra-WriteRuntimeConfig",
              "Infra-WriteApplication1",
              "Infra-WriteApplication2"
            ],
            "_Infra-SQSD-WriteConfig": [
              "Infra-SQSD-WriteConfig"
            ],
            "_Infra-SQSD-Stop": [
              "Infra-SQSD-Stop"
            ],
            "Hook-PreConfigDeploy": [
              "Hook-PreConfigDeploy"
            ],
            "Hook-EnactConfigDeploy": [
              "Hook-EnactConfigDeploy"
            ],
            "InfoTask-BundleLogs": [
              "InfoTask-BundleLogs"
            ],
            "Hook-PostInit": [
              "Hook-PostInit"
            ],
            "Hook-PostAppDeploy": [
              "Hook-PostAppDeploy"
            ],
            "InfoTask-SystemTailLogs": [
              "InfoTask-SystemTailLogs"
            ],
            "Infra-WriteTailLogsConf": [
              "Infra-WriteTailLogsConf"
            ],
            "Infra-WritePublishLogsConf": [
              "Infra-WritePublishLogsConf"
            ],
            "_AppInstallReboot": [
              "Hook-PreAppDeploy"
            ],
            "_Infra-SQSD-Start": [
              "Infra-SQSD-Start"
            ]
          },
          "Infra-WriteLeaderTestScript": {
            "files": {
              "\/opt\/elasticbeanstalk\/bin\/leader-test.sh": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "#!\/bin\/bash",
                      "\n",
                      "if [[ \"$EB_IS_COMMAND_LEADER\" == \"true\" ]]; then ",
                      "\n",
                      "  exit 0 ",
                      "\n",
                      "else  ",
                      "\n",
                      "  exit 1 ",
                      "\n",
                      "fi ",
                      "\n"
                    ]
                  ]
                },
                "mode": "000755"
              }
            }
          },
          "DockerContainerInstallHooksPkg": {
            "sources": {
              "\/opt\/elasticbeanstalk": "https:\/\/s3.amazonaws.com\/elasticbeanstalk-env-resources-us-east-1\/stalks\/eb_docker_2.11.2\/lib\/hooks.tar.gz"
            }
          },
          "Hook-PreRestartAppServer": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/restartappserver\/pre\/"
              }
            }
          },
          "DockerContainerInstallSystemTailLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/docker.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-docker\/containers\/eb-current-app\/*.log",
                      "\/var\/log\/docker-events.log",
                      "\/var\/log\/docker-ps.log",
                      "\/var\/log\/nginx\/*.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "Infra-SQSD-Start": {
            "commands": {
              "01-start-sqsd": {
                "command": "\/etc\/init.d\/aws-sqsd start"
              }
            }
          },
          "DockerContainerInstallPublishLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/publishlogs.d\/docker.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-docker\/containers\/eb-current-app\/*.gz",
                      "\/var\/log\/docker-events.log*.gz",
                      "\/var\/log\/docker-ps.log*.gz",
                      "\/var\/log\/nginx\/*.gz",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "Hook-EnactRestartAppServer": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/restartappserver\/enact\/"
              }
            }
          },
          "Infra-WriteSystemTailLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/eb-version-deployment.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-version-deployment.log",
                      ""
                    ]
                  ]
                }
              },
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/eb-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-cfn-hup-call.log",
                      "\/var\/log\/eb-cfn-init-call.log",
                      "\/var\/log\/eb-cfn-init.log",
                      "\/var\/log\/eb-tools.log",
                      "\/var\/log\/eb-publish-logs.log",
                      "\/var\/log\/directory-hooks-executor.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cron",
                      "\/var\/log\/messages",
                      "\/var\/log\/yum.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/cloud-init-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cloud-init.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/cfn-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cfn-hup.log",
                      "\/var\/log\/cfn-init.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "Hook-PostRestartAppServer": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/restartappserver\/post\/"
              }
            }
          },
          "Infra-WriteRuntimeConfig": {
            "commands": {
              "02writeappsource": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "getMetadata.py --path AWS::ElasticBeanstalk::Ext._AppSourceUrlFileContent > \/opt\/elasticbeanstalk\/deploy\/configuration\/appsourceurl"
                    ]
                  ]
                }
              },
              "03writeconfig": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "getMetadata.py --path AWS::ElasticBeanstalk::Ext._ContainerConfigFileContent > \/opt\/elasticbeanstalk\/deploy\/configuration\/containerconfiguration"
                    ]
                  ]
                }
              },
              "01mkdir": {
                "command": "rm -rf \/opt\/elasticbeanstalk\/deploy\/configuration; mkdir -p \/opt\/elasticbeanstalk\/deploy\/configuration"
              },
              "04setperms": {
                "command": "\/bin\/chmod og-rwx \/opt\/elasticbeanstalk\/deploy\/configuration\/containerconfiguration"
              }
            }
          },
          "Hook-PreInit": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/preinit\/"
              }
            }
          },
          "Infra-WritePublishLogsCron": {
            "files": {
              "\/etc\/cron.d\/publishlogs": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "SHELL=\/bin\/bash",
                      "\n",
                      "PATH=\/sbin:\/bin:\/usr\/sbin:\/usr\/bin",
                      "\n",
                      "MAILTO=root",
                      "\n",
                      "HOME=\/",
                      "\n",
                      "10,30,50 * * * * root ",
                      "publishLogs.py --de-dupe --conf-path '\/opt\/elasticbeanstalk\/tasks\/publishlogs.d\/*' --location-prefix ",
                      {
                        "Fn::FindInMap": [
                          "EnvironmentInfoTasks",
                          "publish",
                          "LocationPrefix"
                        ]
                      },
                      " --num-concurrent 2",
                      "\n",
                      "05,25,45 * * * * root ",
                      "clearStaleLogPublishingRecords.py",
                      "\n"
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "Infra-SQSD-Stop": {
            "commands": {
              "01-stop-sqsd": {
                "command": "\/etc\/init.d\/aws-sqsd stop"
              }
            }
          },
          "AWSEBBaseConfig": {
            "files": {
              "\/etc\/elasticbeanstalk\/.aws-eb-stack.properties": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "environment_id=",
                      {
                        "Ref": "AWSEBEnvironmentId"
                      },
                      "\n",
                      "environment_bucket=",
                      {
                        "Ref": "AWSEBEnvironmentBucket"
                      },
                      "\n",
                      "stack_name=",
                      {
                        "Ref": "AWS::StackId"
                      },
                      "\n",
                      "resource=",
                      "AWSEBAutoScalingGroup",
                      "\n",
                      "region=",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n\n"
                    ]
                  ]
                },
                "owner": "root",
                "group": "root",
                "mode": "000440"
              },
              "\/etc\/cfn\/cfn-hup.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[main]",
                      "\n",
                      "stack=",
                      {
                        "Ref": "AWS::StackId"
                      },
                      "\n",
                      "region=",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n"
                    ]
                  ]
                },
                "owner": "root",
                "group": "root",
                "mode": "000400"
              },
              "\/etc\/cfn\/hooks.d\/aws-eb-command-handler.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[aws-eb-command-handler]",
                      "\n",
                      "triggers=on.command",
                      "\n",
                      "path=ElasticBeanstalkCommand-",
                      "AWSEBAutoScalingGroup",
                      "\n",
                      "action=commandWrapper.py",
                      "\n"
                    ]
                  ]
                }
              }
            },
            "commands": {
              "clearbackupfiles": {
                "command": "rm -f \/etc\/cfn\/hooks.d\/*.bak"
              }
            }
          },
          "InfoTask-TailLogs": {
            "commands": {
              "taillogs": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "tailLogs.py --concatenate --conf-path '\/opt\/elasticbeanstalk\/tasks\/taillogs.d\/*' --location-prefix ",
                      {
                        "Fn::FindInMap": [
                          "EnvironmentInfoTasks",
                          "tail",
                          "LocationPrefix"
                        ]
                      }
                    ]
                  ]
                }
              }
            }
          },
          "Hook-EnactConfigDeploy": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/configdeploy\/enact\/"
              }
            }
          },
          "Hook-PreConfigDeploy": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/configdeploy\/pre\/"
              }
            }
          },
          "Infra-SQSD-Install": {
            "files": {
              "\/etc\/logrotate.d\/aws-sqsd": {
                "content": "\/var\/log\/aws-sqsd\/*.log {\n    daily\n    rotate 10\n    missingok\n    compress\n    copytruncate\n}\n",
                "owner": "root",
                "group": "root",
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/publishlogs.d\/aws-sqsd.conf": {
                "content": "\/var\/log\/aws-sqsd\/*.gz\n",
                "owner": "root",
                "group": "root",
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/bin\/aws-sqsd-dependencies.sh": {
                "content": "#!\/bin\/bash\n#\nRUBY_ROOT=\"\/opt\/elasticbeanstalk\/lib\/sqsd\/ruby\"\nBUCKET=\"elasticbeanstalk-env-resources-us-east-1\"\nRUBY_BUILD_DATE=\"2014-01-17\"\n\non_error() {\n    EXIT_CODE=$?\n    if [ \"${EXIT_CODE}\" != \"0\" ]\n    then\n        echo \"`basename ${0}`:${1-unknown}: error: \\\"${2:-No error message specified}\\\". exit code: ${EXIT_CODE}\"\n        exit 1\n    fi\n}\n\nif [ -d \"${RUBY_ROOT}\" ]\nthen\n    exit 0\nfi\n\nARCHITECTURE=`uname -m`\nif [ \"${ARCHITECTURE}\" == \"i686\" ]\nthen\n    ARCHITECTURE=\"i386\"\nfi\nKEY=\"eb_sqsd\/aws-sqsd-ruby-${ARCHITECTURE}-${RUBY_BUILD_DATE}.tar.gz\"\n\ncurl --retry 10 \"http:\/\/${BUCKET}.s3.amazonaws.com\/${KEY}\" > \/tmp\/aws-sqsd-ruby.tar.gz\non_error ${LINENO} \"download of http:\/\/${BUCKET}.s3.amazonaws.com\/${KEY} failed\"\n\ntar zxf \/tmp\/aws-sqsd-ruby.tar.gz -C \/\non_error ${LINENO} \"extracting archive \/tmp\/aws-sqsd-ruby.tar.gz failed\"\n\nrm -f \/tmp\/aws-sqsd-ruby.tar.gz\n",
                "owner": "root",
                "group": "root",
                "mode": "000755"
              },
              "\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/aws-sqsd.conf": {
                "content": "\/var\/log\/aws-sqsd\/*\n",
                "owner": "root",
                "group": "root",
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/aws-sqsd.conf": {
                "content": "\/var\/log\/aws-sqsd\/*.log\n",
                "owner": "root",
                "group": "root",
                "mode": "000644"
              },
              "\/etc\/cron.d\/aws-sqsd-monitor": {
                "content": "*\/15 * * * * root \/opt\/elasticbeanstalk\/bin\/aws-sqsd-monitor\n",
                "owner": "root",
                "group": "root",
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/bin\/aws-sqsd-monitor": {
                "content": "#!\/bin\/sh\n\nif [ -f \"\/var\/run\/aws-sqsd\/default.pid\" ] && ! \/etc\/init.d\/aws-sqsd status >\/dev\/null 2>&1; then\n\tlogger -t aws-sqsd-monitor \"restarting aws-sqsd...\"\n\t\/etc\/init.d\/aws-sqsd restart\nfi\n",
                "owner": "root",
                "group": "root",
                "mode": "000755"
              },
              "\/opt\/elasticbeanstalk\/tasks\/taillogs.d\/aws-sqsd.conf": {
                "content": "\/var\/log\/aws-sqsd\/*.log\n",
                "owner": "root",
                "group": "root",
                "mode": "000644"
              },
              "\/etc\/init.d\/aws-sqsd": {
                "content": "#!\/bin\/bash\n#\n# chkconfig: - 65 45\n. \/etc\/init.d\/functions\n\nRUBY_PROFILE=\"\/opt\/elasticbeanstalk\/lib\/sqsd\/ruby\/profile.sh\" \n\naws-sqsd() {\n    su sqsd sh -c \"source ${RUBY_PROFILE} && \/opt\/elasticbeanstalk\/lib\/sqsd\/ruby\/bin\/aws-sqsd ${1}\"\n}\n\nUSER=`id -nu`\nif [ \"${USER}\" != \"root\" ]\nthen\n    echo \"aws-sqsd: permission denied\"\n    exit 1\nfi\n\ncase \"$1\" in\nstart)\n     aws-sqsd start\n     RETVAL=$?\n     ;;\nstop)\n    aws-sqsd stop\n    RETVAL=$?\n    ;;\nstatus)\n    aws-sqsd status\n    RETVAL=$?\n    ;;\nrestart|reload|condrestart)\n    aws-sqsd stop\n    aws-sqsd start\n    RETVAL=$?\n    ;;\n*)\n    echo \"Usage: $0 [start|stop|restart|reload|status]\"\n    RETVAL=2\nesac\nexit $RETVAL\n",
                "owner": "root",
                "group": "root",
                "mode": "000755"
              },
              "\/opt\/elasticbeanstalk\/bin\/aws-sqsd-install.rb": {
                "content": "#!\/usr\/bin\/env ruby\n\nrequire 'aws-sdk'\nrequire 'fileutils'\nrequire 'open-uri'\n\nBUCKET = 'elasticbeanstalk-env-resources-us-east-1'\nGEM_NAME = 'aws-sqsd-1.1.gem'\nGEM_KEY = \"eb_sqsd\/#{GEM_NAME}\"\nGEM_PATH = \"\/var\/tmp\/#{GEM_NAME}\"\nUSER = \"sqsd\"\n\n# download the gem\nuri = %[http:\/\/#{BUCKET}.s3.amazonaws.com\/#{GEM_KEY}]\nopen(uri) do |s|\n    open(GEM_PATH, \"w\") do |f|\n        while buf = s.read(32768)\n            f.write buf\n        end\n    end\nend\n\n# install the gem\nsystem %[gem install --local --bindir \/opt\/elasticbeanstalk\/lib\/sqsd\/ruby\/bin #{GEM_PATH} 2>&1]\nunless $?.exitstatus == 0\n    puts %[installing gem \"#{GEM_PATH}\" failed]\n    exit 1\nend\nFileUtils.rm_f GEM_PATH\n\n# create the daemon user\nunless (Etc.getpwnam USER rescue nil)\n    system %[\/usr\/sbin\/useradd --no-create-home --comment \"AWS SQSD Daemon\" #{USER}]\n    unless $?.exitstatus == 0\n        puts %[creating the user \"#{USER}\" failed]\n        exit 1\n    end\nend\n\n# create log pid and configuration directories\n%w[\/var\/log\/aws-sqsd \/var\/run\/aws-sqsd \/etc\/aws-sqsd.d].each do |path|\n    FileUtils.mkdir_p path\n    FileUtils.chown USER, USER, path\nend\n",
                "owner": "root",
                "group": "root",
                "mode": "000755"
              }
            },
            "commands": {
              "03-install-dependencies": {
                "command": "umask 0022 && \/opt\/elasticbeanstalk\/bin\/aws-sqsd-dependencies.sh"
              },
              "04-install-aws-sqsd": {
                "command": "source \/opt\/elasticbeanstalk\/lib\/sqsd\/ruby\/profile.sh && umask 0022 && \/opt\/elasticbeanstalk\/bin\/aws-sqsd-install.rb"
              },
              "01-cron.d-clean": {
                "command": "rm -rf \/etc\/cron.d\/aws-sqsd-monitor.bak"
              },
              "02-sqsd-config-clean": {
                "command": "rm -rf \/etc\/aws-sqsd.d\/*.bak"
              }
            }
          },
          "InfoTask-BundleLogs": {
            "commands": {
              "bundlelogs": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "bundleLogs.py --conf-path '\/opt\/elasticbeanstalk\/tasks\/bundlelogs.d\/*' --location-prefix ",
                      {
                        "Fn::FindInMap": [
                          "EnvironmentInfoTasks",
                          "bundle",
                          "LocationPrefix"
                        ]
                      }
                    ]
                  ]
                }
              }
            }
          },
          "Infra-SQSD-WriteConfig": {
            "commands": {
              "01-write-sqsd-config": {
                "command": "getMetadata.py --yaml --path AWS::ElasticBeanstalk::Ext._SqsDaemonConfigFileContent | sed \"s\/'\/\/g\" > \/etc\/aws-sqsd.d\/default.yaml"
              }
            }
          },
          "Infra-SQSD-EnsureRunning": {
            "services": {
              "sysvinit": {
                "aws-sqsd": {
                  "ensureRunning": true,
                  "enabled": true,
                  "sources": [
                    "\/etc\/aws-sqsd.d"
                  ]
                }
              }
            }
          },
          "Hook-PostInit": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/postinit\/"
              }
            }
          },
          "DockerContainerInstallTailLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/taillogs.d\/docker.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-docker\/containers\/eb-current-app\/*.log",
                      "\/var\/log\/docker-events.log",
                      "\/var\/log\/docker-ps.log",
                      "\/var\/log\/nginx\/*.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "LockRepoToGuid": {
            "files": {
              "\/etc\/yum\/vars\/guid": {
                "content": "101d655db21e",
                "mode": "000644"
              }
            },
            "commands": {
              "03yumRepoMetaClean": {
                "command": "yum clean all"
              },
              "01cloudTemplates": {
                "command": "sed -i -r 's\/mirror.list$\/mirror.list-\\$guid\/' \/etc\/cloud\/templates\/amzn-updates.repo.tmpl"
              },
              "02yumRepos": {
                "command": "sed -i -r 's\/mirror.list$\/mirror.list-$guid\/' \/etc\/yum.repos.d\/amzn-updates.repo"
              },
              "04UpdateOpenssl": {
                "command": "yum update -y openssl"
              }
            }
          },
          "Hook-PostAppDeploy": {
            "commands": {
              "hooks": {
                "command": "directoryHooksExecutor.py --path \/opt\/elasticbeanstalk\/hooks\/appdeploy\/post\/"
              }
            }
          },
          "InfoTask-SystemTailLogs": {
            "commands": {
              "systemtaillogs": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "tailLogs.py --conf-path '\/opt\/elasticbeanstalk\/tasks\/systemtaillogs.d\/*' --location-prefix ",
                      {
                        "Fn::FindInMap": [
                          "EnvironmentInfoTasks",
                          "systemtail",
                          "LocationPrefix"
                        ]
                      }
                    ]
                  ]
                }
              }
            }
          },
          "Infra-WriteTailLogsConf": {
            "files": {
              "\/opt\/elasticbeanstalk\/tasks\/taillogs.d\/cfn-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/cfn-hup.log",
                      "\/var\/log\/cfn-init.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              },
              "\/opt\/elasticbeanstalk\/tasks\/taillogs.d\/eb-version-deployment.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-version-deployment.log",
                      ""
                    ]
                  ]
                }
              },
              "\/opt\/elasticbeanstalk\/tasks\/taillogs.d\/eb-system.conf": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "\/var\/log\/eb-cfn-hup-call.log",
                      "\/var\/log\/eb-cfn-init-call.log",
                      "\/var\/log\/eb-cfn-init.log",
                      "\/var\/log\/eb-tools.log",
                      "\/var\/log\/eb-publish-logs.log",
                      "\/var\/log\/directory-hooks-executor.log",
                      ""
                    ]
                  ]
                },
                "mode": "000644"
              }
            }
          },
          "Infra-WritePublishLogsConf": {
            "files": {
              
            }
          },
          "AWSEBCfnHup": {
            "services": {
              "sysvinit": {
                "cfn-hup": {
                  "ensureRunning": "true"
                }
              }
            }
          }
        }
      },
      "DependsOn": "AWSEBBeanstalkMetadata",
      "Properties": {
        "Tags": [
          {
            "PropagateAtLaunch": true,
            "Value": {
              "Ref": "AWSEBEnvironmentName"
            },
            "Key": "elasticbeanstalk:environment-name"
          },
          {
            "PropagateAtLaunch": true,
            "Value": {
              "Ref": "AWSEBEnvironmentName"
            },
            "Key": "Name"
          },
          {
            "PropagateAtLaunch": true,
            "Value": {
              "Ref": "AWSEBEnvironmentId"
            },
            "Key": "elasticbeanstalk:environment-id"
          }
        ],
        "AvailabilityZones": [
          "us-east-1c",
          "us-east-1b",
          "us-east-1e"
        ],
        "MaxSize": 1,
        "Cooldown": "360",
        "LaunchConfigurationName": {
          "Ref": "AWSEBAutoScalingLaunchConfiguration"
        },
        "MinSize": 1
      }
    },
    "AWSEBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "SecurityGroup for ElasticBeanstalk environment."
      }
    },
    "AWSEBInstanceLaunchWaitHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle"
    },
    "AWSEBWorkerQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "MessageRetentionPeriod": 1209600,
        "RedrivePolicy": {
          "deadLetterTargetArn": {
            "Fn::GetAtt": [
              "AWSEBWorkerDeadLetterQueue",
              "Arn"
            ]
          },
          "maxReceiveCount": {
            "Ref": "AWSEBMaxRetries"
          }
        },
        "VisibilityTimeout": 43200
      }
    },
    "AWSEBSecurityGroupSSHIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "tcp",
        "GroupName": {
          "Ref": "AWSEBSecurityGroup"
        },
        "ToPort": "22",
        "FromPort": "22",
        "CidrIp": "0.0.0.0\/0"
      }
    },
    "AWSEBBeanstalkMetadata": {
      "Type": "AWS::CloudFormation::WaitConditionHandle",
      "Metadata": {
        "AWS::ElasticBeanstalk::Ext": {
          "Parameters": {
            "DockerRPM": {
              "Ref": "DockerRPM"
            },
            "LogPublicationControl": {
              "Ref": "LogPublicationControl"
            },
            "AWSEBVisibilityTimeout": {
              "Ref": "AWSEBVisibilityTimeout"
            },
            "AWSEBAgentId": {
              "Ref": "AWSEBAgentId"
            },
            "AWSEBWorkerQueueURL": {
              "Ref": "AWSEBWorkerQueueURL"
            },
            "AWSEBEnvironmentName": {
              "Ref": "AWSEBEnvironmentName"
            },
            "AWSEBHttpPath": {
              "Ref": "AWSEBHttpPath"
            },
            "InstanceType": {
              "Ref": "InstanceType"
            },
            "AWSEBMaxRetries": {
              "Ref": "AWSEBMaxRetries"
            },
            "AWSEBHealthCheck": {
              "Ref": "AWSEBHealthCheck"
            },
            "AWSEBReferrerId": {
              "Ref": "AWSEBReferrerId"
            },
            "DockerProxyServer": {
              "Ref": "DockerProxyServer"
            },
            "DockerDEB": {
              "Ref": "DockerDEB"
            },
            "InstancePort": {
              "Ref": "InstancePort"
            },
            "AWSEBHttpConnections": {
              "Ref": "AWSEBHttpConnections"
            },
            "AWSEBEnvironmentId": {
              "Ref": "AWSEBEnvironmentId"
            },
            "AWSEBEnvironmentBucket": {
              "Ref": "AWSEBEnvironmentBucket"
            },
            "AWSEBMimeType": {
              "Ref": "AWSEBMimeType"
            },
            "AppSource": {
              "Ref": "AppSource"
            },
            "AWSEBInactivityTimeout": {
              "Ref": "AWSEBInactivityTimeout"
            },
            "AWSEBConnectTimeout": {
              "Ref": "AWSEBConnectTimeout"
            },
            "EnvironmentVariables": {
              "Ref": "EnvironmentVariables"
            },
            "AWSEBRetentionPeriod": {
              "Ref": "AWSEBRetentionPeriod"
            },
            "AWSEBWorkerDeadLetterQueueURL": {
              "Ref": "AWSEBWorkerDeadLetterQueueURL"
            }
          }
        },
        "AWS::ElasticBeanstalk::Metadata": {
          "Name": "e-fucvpi5vsv",
          "EnvironmentName": "dockertest-env",
          "Description": "TemplatePack for environment: dockertest-env",
          "DateCreated": "2014-06-26T22:50:19",
          "DateUpdated": "2014-06-26T22:50:19",
          "EnvironmentId": "e-fucvpi5vsv",
          "Version": "3ea3f698-fd84-11e3-8f55-7d1a7a083030"
        }
      }
    }
  }
}
